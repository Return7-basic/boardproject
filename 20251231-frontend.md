# 프론트엔드 변경 사항 (2025-12-31)

## 📋 개요
댓글 수정/삭제 실시간 반영, 게시글 페이지네이션 오류 수정, 댓글 정렬 기능 개선 등의 기능을 구현했습니다.

---

## 🔧 수정된 파일 목록

### 1. **useReplies.js**
**경로**: `board-frontend/src/hooks/useReplies.js`

#### 변경 사항:

**1.1. 댓글 목록 조회 기본값 변경**
- **위치**: `useReplies()` 훅
- **변경 내용**: `sort` 기본값을 `'latest'`에서 `'ascending'`으로 변경
- **코드**:
```javascript
export function useReplies(boardId, sort = 'ascending') {
  return useInfiniteQuery({
    queryKey: ['replies', boardId, sort],
    // ...
  });
}
```

**1.2. 댓글 수정 실시간 UI 업데이트**
- **위치**: `useUpdateReply()` 훅의 `onSuccess` 콜백
- **변경 내용**: `setQueryData`를 사용하여 수정된 댓글을 즉시 UI에 반영
- **코드**:
```javascript
onSuccess: (updatedReply, variables) => {
  if (!updatedReply || !updatedReply.id) {
    queryClient.invalidateQueries({ queryKey: ['replies', boardId] });
    queryClient.invalidateQueries({ queryKey: ['selectedReply', boardId] });
    return;
  }

  // 실시간 UI 업데이트 (평면 배열에서 직접 업데이트)
  queryClient.setQueryData(['replies', boardId], (oldData) => {
    if (!oldData || !oldData.pages) {
      queryClient.invalidateQueries({ queryKey: ['replies', boardId] });
      return oldData;
    }

    const updatedPages = oldData.pages.map((page) => {
      if (!page.items || !Array.isArray(page.items)) return { ...page };

      const itemIndex = page.items.findIndex(item => item.id === updatedReply.id);
      if (itemIndex === -1) return { ...page };

      const updatedItems = [...page.items];
      updatedItems[itemIndex] = { ...updatedReply };

      return {
        ...page,
        items: updatedItems,
      };
    });

    return {
      ...oldData,
      pages: updatedPages,
    };
  });

  // 채택된 댓글도 갱신
  queryClient.setQueryData(['selectedReply', boardId], (oldSelectedReply) => {
    if (oldSelectedReply && oldSelectedReply.id === updatedReply.id) {
      return { ...updatedReply };
    }
    return oldSelectedReply;
  });
}
```

**1.3. 댓글 삭제 실시간 UI 업데이트**
- **위치**: `useDeleteReply()` 훅의 `onSuccess` 콜백
- **변경 내용**: Soft delete 시 `setQueryData`로 즉시 UI 업데이트, Hard delete 시 전체 쿼리 무효화
- **코드**:
```javascript
onSuccess: (response, replyId) => {
  if (response.status === 204) {
    // hard delete - 전체 목록 갱신
    queryClient.invalidateQueries({ queryKey: ['replies', boardId] });
    queryClient.invalidateQueries({ queryKey: ['selectedReply', boardId] });
  } else {
    // soft delete - 평면 배열에서 직접 업데이트
    const deletedReply = response.data;
    
    if (!deletedReply) {
      queryClient.invalidateQueries({ queryKey: ['replies', boardId] });
      queryClient.invalidateQueries({ queryKey: ['selectedReply', boardId] });
      return;
    }

    queryClient.setQueryData(['replies', boardId], (oldData) => {
      if (!oldData || !oldData.pages) return oldData;
      
      const updatedPages = oldData.pages.map((page) => {
        if (!page.items || !Array.isArray(page.items)) return { ...page };
        
        const itemIndex = page.items.findIndex(item => item.id === replyId);
        if (itemIndex === -1) return { ...page };
        
        const updatedItems = [...page.items];
        updatedItems[itemIndex] = { ...deletedReply };
        
        return {
          ...page,
          items: updatedItems,
        };
      });
      
      return {
        ...oldData,
        pages: updatedPages,
      };
    });
    
    queryClient.setQueryData(['selectedReply', boardId], (oldSelectedReply) => {
      if (oldSelectedReply && oldSelectedReply.id === replyId) {
        return { ...deletedReply };
      }
      return oldSelectedReply;
    });
  }
}
```

**1.4. 댓글 추천/비추천 낙관적 업데이트**
- **위치**: `useUpVoteReply()` / `useDownVoteReply()` 훅
- **변경 내용**: 낙관적 업데이트 적용 및 댓글 작성 직후 추천/비추천 시에도 정상 작동하도록 개선
- **코드**:
```javascript
onSuccess: (voteType, replyId, context) => {
  if (voteType === 'CANCEL' && context?.previousReplies) {
    // 취소 시 이전 상태로 롤백
    queryClient.setQueryData(['replies', boardId], context.previousReplies);
    queryClient.setQueryData(['selectedReply', boardId], context.previousSelected);
  } else {
    // 댓글이 캐시에 없으면 재조회 (댓글 작성 직후 추천/비추천 시)
    const currentData = queryClient.getQueryData(['replies', boardId]);
    const replyExists = currentData?.pages?.some(page =>
      page.items?.some(item => item.id === replyId)
    );
    if (!replyExists) {
      queryClient.invalidateQueries({ queryKey: ['replies', boardId] });
      queryClient.invalidateQueries({ queryKey: ['selectedReply', boardId] });
    }
  }
}
```

---

### 2. **ReplyItem.js**
**경로**: `board-frontend/src/components/reply/ReplyItem.js`

#### 변경 사항:

**2.1. isDeleted 필드 명시적 확인**
- **위치**: 컴포넌트 내부
- **변경 내용**: `reply.isDeleted === true`로 명시적으로 확인하여 삭제된 댓글 표시
- **코드**:
```javascript
const isDeleted = reply.isDeleted === true;
```

**2.2. 조건부 렌더링 개선**
- **위치**: 댓글 내용 및 액션 버튼 렌더링
- **변경 내용**: `isDeleted`가 `true`일 때 "삭제된 댓글입니다." 메시지 표시 및 액션 버튼 숨김
- **코드**:
```javascript
{isEditing ? (
  // 편집 폼
) : (
  <div className="mb-4">
    <p className={`text-slate-300 whitespace-pre-wrap ${isDeleted ? 'italic text-slate-500' : ''}`}>
      {isDeleted ? '삭제된 댓글입니다.' : reply.content}
    </p>
  </div>
)}

{!isEditing && !isDeleted && (
  // 액션 버튼들 (수정, 삭제, 답글, 채택)
)}
```

---

### 3. **ReplyList.js**
**경로**: `board-frontend/src/components/reply/ReplyList.js`

#### 변경 사항:

**3.1. 정렬 기본값 변경**
- **위치**: `useState` 초기값
- **변경 내용**: 기본값을 `'latest'`에서 `'ascending'`으로 변경
- **코드**:
```javascript
const [sort, setSort] = useState('ascending');
```

**3.2. 필터 옵션 추가**
- **위치**: 정렬 옵션 버튼
- **변경 내용**: 필터 옵션을 3개로 수정 (기본순, 최신순, 추천순)
- **코드**:
```javascript
<div className="flex gap-2">
  <Button
    size="sm"
    variant={sort === 'ascending' ? 'default' : 'ghost'}
    onClick={() => setSort('ascending')}
  >
    기본순
  </Button>
  <Button
    size="sm"
    variant={sort === 'latest' ? 'default' : 'ghost'}
    onClick={() => setSort('latest')}
  >
    최신순
  </Button>
  <Button
    size="sm"
    variant={sort === 'recommendation' ? 'default' : 'ghost'}
    onClick={() => setSort('recommendation')}
  >
    추천순
  </Button>
</div>
```

**3.3. handleUpdate 함수 단순화**
- **위치**: `handleUpdate()` 함수
- **변경 내용**: 단순히 `updateReply(data)` 호출, UI 업데이트는 `useUpdateReply` 훅에서 처리
- **코드**:
```javascript
const handleUpdate = (data) => {
  updateReply(data);
};
```

---

### 4. **BoardList.js**
**경로**: `board-frontend/src/components/board/BoardList.js`

#### 변경 사항:

**4.1. 페이지네이션 로직 개선**
- **위치**: `useBoards` 훅 호출 및 `hasNextPage` 계산
- **변경 내용**: `size + 1` 대신 `size`만 전달, `hasNextPage`는 백엔드에서 제공하는 `hasNext` 필드 사용
- **코드**:
```javascript
// 정확히 size개만 요청 (백엔드에서 hasNext 정보 제공)
const { data: boardData, isLoading, isError, error } = useBoards(page, size);

// 실제 표시할 게시글
const displayBoards = boardData?.items || [];
// 다음 페이지가 있는지 확인 (백엔드에서 제공)
const hasNextPage = boardData?.hasNext || false;
```

**4.2. 빈 목록 메시지 조건 개선**
- **위치**: 빈 목록 렌더링
- **변경 내용**: `page === 0`이고 `displayBoards.length === 0`일 때만 표시
- **코드**:
```javascript
// 빈 목록 (page가 0이고 게시글이 없을 때만)
if (page === 0 && (!displayBoards || displayBoards.length === 0)) {
  // "아직 등록된 질문이 없습니다" 메시지 표시
}
```

---

### 5. **useBoards.js**
**경로**: `board-frontend/src/hooks/useBoards.js`

#### 변경 사항:

**5.1. BoardListResponseDto 형태로 데이터 처리**
- **위치**: `useBoards()` 훅
- **변경 내용**: `BoardListResponseDto` 형태의 데이터를 반환받도록 변경 (`items`, `hasNext` 필드 포함)
- **코드**:
```javascript
export function useBoards(page = 0, size = 10) {
  return useQuery({
    queryKey: ['boards', page, size],
    queryFn: () => getBoards(page, size),
  });
}
```

---

### 6. **replies.js**
**경로**: `board-frontend/src/api/replies.js`

#### 변경 사항:

**6.1. getSelectedReply 기본값 변경**
- **위치**: `getReplies()` 함수
- **변경 내용**: `sort` 기본값을 `'latest'`에서 `'ascending'`으로 변경
- **코드**:
```javascript
export const getReplies = async (boardId, params = {}) => {
  const { cursorId, size = 100, sort = 'ascending', cursorScore } = params;
  // ...
};
```

**6.2. getSelectedReply 404 에러 처리**
- **위치**: `getSelectedReply()` 함수
- **변경 내용**: 404 에러를 catch하여 `null` 반환, 채택된 댓글이 없을 때 예외 대신 `null` 처리
- **코드**:
```javascript
export const getSelectedReply = async (boardId) => {
  try {
    const response = await api.get(`/api/boards/${boardId}/replies/selected`);
    return response.data;
  } catch (error) {
    if (error.response && error.response.status === 404) {
      console.log('채택된 댓글이 없습니다 (404).');
      return null; // 404 에러 시 null 반환
    }
    throw error;
  }
};
```

---

## 🎯 주요 개선 사항

### 1. 실시간 UI 업데이트
- 댓글 수정/삭제 시 새로고침 없이 즉시 UI 반영
- React Query의 `setQueryData`를 활용한 낙관적 업데이트

### 2. 댓글 정렬 기능 개선
- 기본순(오름차순), 최신순(내림차순), 추천순 옵션 제공
- 기본값을 "ascending"으로 변경

### 3. 페이지네이션 개선
- 백엔드에서 제공하는 `hasNext` 정보 활용
- 정확한 페이지네이션 구현

### 4. 에러 처리 개선
- 채택된 댓글 조회 시 404 에러 graceful 처리
- 댓글 작성 직후 추천/비추천 시 캐시 확인 로직 추가

### 5. Soft Delete UI 반영
- `isDeleted` 필드를 명시적으로 확인하여 삭제된 댓글 표시
- 삭제된 댓글에는 액션 버튼 숨김

---

## 🐛 해결된 문제들

1. ✅ **댓글 수정 후 반영이 바로 되지 않음**
   - `useUpdateReply` 훅에서 `setQueryData`로 즉시 UI 업데이트

2. ✅ **실시간 댓글 추천 반영이 바로 되지 않음**
   - `useUpVoteReply` / `useDownVoteReply` 훅에 낙관적 업데이트 적용

3. ✅ **대댓글 가지고있는 댓글 삭제시 soft 삭제 반영안됨**
   - `useDeleteReply` 훅에서 `setQueryData`로 즉시 UI 업데이트

4. ✅ **대댓글 가지고 있는 댓글 수정시 수정 반영 안됨**
   - `useUpdateReply` 훅에서 평면 배열에서 직접 업데이트

5. ✅ **게시글 10개인 상태에서 다음버튼이 활성화 되어있음**
   - 백엔드에서 `hasNext` 정보 제공, 프론트엔드에서 정확히 사용

6. ✅ **11개 게시글 시 2페이지에 게시글이 보이지 않음**
   - 페이지네이션 로직 개선 (`size + 1` 제거, `hasNext` 사용)

7. ✅ **"아직 등록된 질문이 없습니다" 메시지가 잘못 표시됨**
   - `page === 0`이고 게시글이 없을 때만 표시하도록 수정

8. ✅ **댓글 작성 직후 추천/비추천이 반영되지 않음**
   - 댓글이 캐시에 없을 경우 쿼리 무효화로 재조회

9. ✅ **채택된 댓글 조회 API 404 에러**
   - `getSelectedReply`에서 404를 catch하여 `null` 반환

10. ✅ **isDeleted 필드가 프론트엔드에서 반영되지 않음**
    - `reply.isDeleted === true`로 명시적 확인

---

## 📌 사용 방법

### 댓글 정렬 옵션
- **기본순** (`ascending`): ID 오름차순 (가장 오래된 댓글부터)
- **최신순** (`latest`): ID 내림차순 (가장 최신 댓글부터)
- **추천순** (`recommendation`): 추천수 내림차순, ID 내림차순

---

## ⚠️ 주의사항

1. **정렬 기본값 변경**으로 인해 기존 사용자 경험에 영향을 줄 수 있습니다.
2. **실시간 UI 업데이트**는 React Query의 캐시를 직접 수정하므로, 데이터 일관성을 유지하기 위해 주의가 필요합니다.
3. **낙관적 업데이트**는 서버 응답 전에 UI를 업데이트하므로, 에러 발생 시 롤백 로직이 필요합니다.

---

## 📝 테스트 체크리스트

- [ ] 댓글 수정 후 즉시 UI 반영 확인
- [ ] 댓글 삭제 후 즉시 UI 반영 확인 (soft delete)
- [ ] 댓글 추천/비추천 즉시 반영 확인
- [ ] 댓글 정렬 기능 (기본순, 최신순, 추천순)
- [ ] 게시글 페이지네이션 (`hasNext` 확인)
- [ ] 삭제된 댓글 표시 확인
- [ ] 채택된 댓글 조회 404 처리 확인
- [ ] 댓글 작성 직후 추천/비추천 반영 확인

